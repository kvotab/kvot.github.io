const G=[1,1.5,11/6,25/12,137/60],DIFUFULL=[[-1,-2,-3,-4,-5],[0,1,3,6,10],[0,0,-1,-4,-10],[0,0,0,1,5],[0,0,0,0,-1]],EPS=2**-52,BR=EPS**.875,BL=EPS**.75,BU=EPS**.25,FAC_MIN=EPS**.78,FAC_MAX=.1,MAX_VALUE=Number.MAX_VALUE,MIN_VALUE=2**-1022;function ndf(t,e,r,l={}){let{RelTol:a,AbsTol:n,NormControl:f,NonNegative:o,AutoUpdateAbsTol:h,MaxStep:i,InitialStep:M,Refine:s,MaxOrder:A,BDF:b,Events:m,Jacobian:u}={RelTol:.001,AbsTol:1e-6,NormControl:!1,NonNegative:[],AutoUpdateAbsTol:!1,MaxStep:-1,InitialStep:-1,Refine:1,MaxOrder:5,BDF:!1,Events:null,Jacobian:null,...l};const w=e.length,y=e[0],g=e[w-1],x=Math.abs(e[1]-e[0]),d=r.length,p=Math.sign(g-y),c=null!==m,U=null!==u;let E,L,F=0,N=0;f&&(F=norm(r));var _=null,S=!1;let v;v=b?[0,0,0,0,0]:[-.185,-1/9,-.0823,-.0415,0];let k=new Array(5),I=new Array(5);for(let t=0;t<5;t++)k[t]=1/(G[t]*(1-v[t])),I[t]=v[t]*G[t]+1/(t+2);let P=new Array(A);for(let t=0;t<A;t++){P[t]=new Array(A);for(let e=0;e<A;e++)P[t][e]=DIFUFULL[t][e]}let B,C=2;n instanceof Array||(n=new Array(d).fill(n)),B=i<0?Math.abs(.1*(g-y)):Math.min(i,Math.abs(g-y));let V=new Array(d);for(let t=0;t<d;t++)V[t]=n[t]/a;o.length>0&&(t=odeNonNegative(t,o));const X=t(y,r);c&&(_=m.fun(y,r));let D=y,R=[...r],T=y,q=[...r],z=[y],j=new Array(d);for(let t=0;t<d;t++)j[t]=[r[t]];let J=[...X];if(U)var O=u;else var{dFdy:O,fac:H}=numjac(t,D,R,X,n);let K,Q,W=!0,Y=16*ulp(y);if(M<0){let e=0;for(let t=0;t<d;t++)e=Math.max(e,Math.abs(J[t]/Math.max(Math.abs(r[t]),V[t])));e/=.8*Math.sqrt(a),K=Math.min(B,x),K*e>1&&(K=1/e),K=Math.max(K,Y),Q=p*K;let l=D+p*Math.min(Math.sqrt(EPS)*Math.max(Math.abs(D),Math.abs(D+Q)),K)-D,n=t(D+l,R),f=new Array(d);for(let t=0;t<d;t++){f[t]=(n[t]-X[t])/l;for(let e=0;e<d;e++)f[t]+=O[t][e]*J[e]}e=0;for(let t=0;t<d;t++)e=Math.max(e,Math.abs(f[t]/Math.max(Math.abs(r[t]),V[t])));e=1.25*Math.sqrt(.5*e/a),K=Math.min(B,x),K*e>1&&(K=1/e),K=Math.max(K,Y)}else K=Math.min(B,Math.max(Y,M));Q=p*K;let Z=1,$=Z,tt=K,et=new Array(A+2);for(let t=0;t<A+2;t++)et[t]=new Array(d).fill(0);for(let t=0;t<d;t++)et[0][t]=Q*J[t];let rt=Q*k[Z-1],lt=0,at=new Array(d);for(let t=0;t<d;t++)at[t]=new Array(d);initLU(O,rt,at);let nt=lu(at),ft=!1,ot=0,ht=!1,it=!1,Mt=new Array(d),st=new Array(d),At=new Array(d);for(;!ht;){Y=16*ulp(D),K=Math.min(B,Math.max(Y,K)),K===Y?(it&&(K=tt),it=!0):it=!1,Q=p*K,1.1*K>=Math.abs(g-D)&&(Q=g-D,K=Math.abs(Q),ht=!0),K===tt&&Z===$||(updateDif(K/tt,P,d,Z,A,et),rt=Q*k[Z-1],lt=0,initLU(O,rt,at),nt=lu(at),ft=!1);let r=!0;for(;;){let e=!1;for(;!e;){if(1===Z)for(let t=0;t<d;t++)At[t]=et[0][t]*G[0]*k[Z-1];else{let t=new Array(Z),e=new Array(Z);for(let r=0;r<Z;r++)t[r]=[...et[r]],e[r]=G[r]*k[Z-1];At.fill(0);for(let r=0;r<Z;r++){let l=t[r];for(let t=0;t<d;t++)At[t]+=l[t]*e[r]}}T=D+Q,ht&&(T=g),Q=T-D;let r=[...R];for(let t=0;t<d;t++)for(let e=0;e<Z;e++)r[t]+=et[e][t];q=[...r],Mt.fill(0);let l=0;if(f)N=norm(q),st[0]=1/Math.max(Math.max(F,N),V[0]),l=100*EPS*(N*st[0]);else{for(let t=0;t<d;t++)st[t]=1/Math.max(Math.max(Math.abs(R[t]),Math.abs(q[t])),V[t]),l=Math.max(l,Math.abs(q[t]*st[t]));l*=100*EPS}let o,h=4,i=!1,M=0;for(let n=1;n<=h;n++){let s=t(T,q);for(let t=0;t<d;t++)s[t]*=rt,s[t]-=At[t]+Mt[t];let A=lusolve(at,nt,s),b=0;if(f)b=norm(A)*st[0];else for(let t=0;t<d;t++){b=Math.max(b,Math.abs(A[t]*st[t]))}for(let t=0;t<d;t++)Mt[t]+=A[t],q[t]=r[t]+Mt[t];if(b<=l){e=!0;break}if(1===n)if(ft){if(o=b*ot/(1-ot),o<=.05*a){e=!0;break}}else ot=0;else{if(b>.9*M){i=!0;break}if(ot=Math.max(.9*ot,b/M),ft=!0,o=b*ot/(1-ot),o<=.5*a){e=!0;break}if(n===h){i=!0;break}if(.5*a<o*ot**(h-n)){i=!0;break}}M=b}if(i){if(W){if(K<=Y)throw new Error("Failure at t="+D+".  Unable to meet integration tolerances without reducing the step size below the smallest value allowed ("+Y+") at time t.");tt=K,K=Math.max(Y,.3*K),Q=p*K,ht=!1,updateDif(K/tt,P,d,Z,A,et),rt=Q*k[Z-1],lt=0}else{var{dFdy:O,fac:H}=numjac(t,D,R,t(D,R),n,H);W=!0}initLU(O,rt,at),nt=lu(at),ft=!1}}if(L=0,f)L=norm(Mt)*st[0];else for(let t=0;t<d;t++){let e=Math.abs(Mt[t]*st[t]);L<e&&(L=e)}if(L*=I[Z-1],o.length>0&&L<=a){let t=!1;for(let e=0;e<o.length;e++)if(q[o[e]]<0){t=!0;break}if(t){let t=0;if(f){let e=new Array(o.length);for(let t=0;t<e.length;t++)e[t]=Math.max(0,-q[o[t]]);t=norm(e)*st[0]}else for(let e=0;e<o.length;e++){let r=Math.abs(Math.max(0,-q[o[e]])/V[o[e]]);t<r&&(t=r)}t>a&&(L=t)}}if(!(L>a)){if(h)for(let t=0;t<d;t++)n[t]=Math.max(n[t],a*Math.abs(q[t])),V[t]=n[t]/a;break}if(K<=Y)throw new Error("Failure at t="+D+".  Unable to meet integration tolerances without reducing the step size below the smallest value allowed ("+Y+") at time t.");if(tt=K,r){if(r=!1,E=K*Math.max(.1,.833*Math.pow(a/L,1/(Z+1))),Z>1){let t=0;if(f){let e=[...et[Z-1]];for(let t=0;t<e.length;t++)e[t]+=Mt[t];t=norm(e)*st[0]}else for(let e=0;e<d;e++)t=Math.max(t,Math.abs((et[Z-1][e]+Mt[e])*st[e]));t*=I[Z-2];let e=K*Math.max(.1,.769*Math.pow(a/t,1/Z));e>E&&(E=Math.min(K,e),Z--)}K=Math.max(Y,E)}else K=Math.max(Y,.5*K);if(K<=Y){K=tt;break}Q=p*K,K<tt&&(ht=!1),updateDif(K/tt,P,d,Z,A,et),rt=Q*k[Z-1],lt=0,initLU(O,rt,at),nt=lu(at),ft=!1}for(let t=0;t<d;t++)et[Z+1][t]=Mt[t]-et[Z][t],et[Z][t]=Mt[t];for(let t=Z-1;t>=0;t--)for(let e=0;e<d;e++)et[t][e]=et[t][e]+et[t+1][e];let l,i=!1;if(o.length>0){let t=!1;l=new Array(o.length);for(let e=0;e<o.length;e++)q[o[e]]<0?(t=!0,q[o[e]]=0,l[e]=!0):l[e]=!1;t&&(f&&(N=norm(q)),i=!0)}if(c){var{te:bt,ye:mt,stop:S}=odezero(m,_,D,R,T,q,y,Q,et,Z,o);if(S){let t=new Array(Z+1);for(let e=0;e<Z+1;e++)t[e]=ntrpndf(bt-e*(bt-D),T,q,Q,et,Z,o);for(let e=1;e<Z+1;e++){let r=new Array(Z+1-e);for(let t=0;t<d;t++)r[t]=new Array(d);for(let l=e;l<Z+1;l++)for(let a=0;a<d;a++)r[l-e][a]=t[l-1][a]-t[l][a];for(let l=e;l<Z+1;l++)t[l]=r[l-e]}for(let e=0;e<Z;e++)et[e]=[...t[e+1]];T=bt,q=mt,Q=T-D,ht=!0}}if(w>2)for(;C<=w;){if(p*(T-e[C-1])<0){if(c&&S){z[z.length]=T;for(let t=0;t<d;t++)j[t][j[t].length]=q[t]}break}if(e[C-1]===T){z[z.length]=T;for(let t=0;t<d;t++)j[t][j[t].length]=q[t]}else{let t=ntrpndf(e[C-1],T,q,Q,et,Z,o);z[z.length]=e[C-1];for(let e=0;e<d;e++)j[e][j[e].length]=t[e]}C++}else if(s>1){for(let t=0;t<s-1;t++){let e=D+(T-D)*(t+1)/s,r=ntrpndf(e,T,q,Q,et,Z,o);z[z.length]=e;for(let t=0;t<d;t++)j[t][j[t].length]=r[t]}z[z.length]=T;for(let t=0;t<d;t++)j[t][j[t].length]=q[t]}else{z[z.length]=T;for(let t=0;t<d;t++)j[t][j[t].length]=q[t]}if(ht){D=T,R=[...q];break}if($=Z,tt=K,lt=Math.min(lt+1,A+2),lt>=Z+2){let t=1.2*Math.pow(L/a,1/(Z+1));E=t>.1?K/t:10*K;let e=Z;if(Z>1){let r,l=0;if(f)l=norm(et[Z-1])*st[0];else for(let t=0;t<d;t++)l=Math.max(l,Math.abs(et[Z-1][t]*st[t]));l*=I[Z-2],t=1.3*Math.pow(l/a,1/Z),r=t>.1?K/t:10*K,r>E&&(E=r,e=Z-1)}if(Z<A){let r,l=0;if(f)l=norm(et[Z+1])*st[0];else for(let t=0;t<d;t++)l=Math.max(l,Math.abs(et[Z+1][t]*st[t]));l*=I[Z],t=1.4*Math.pow(l/a,1/(Z+2)),r=t>.1?K/t:10*K,r>E&&(E=r,e=Z+1)}E>K&&(K=E,Z!==e&&(Z=e))}if(D=T,R=[...q],i)for(let t=0;t<l.length;t++)if(l[t])for(let e=0;e<A+2;e++)et[e][o[t]]=0;f&&(F=N),U||(W=!1)}return{tout:z,yout:j}}function updateDif(t,e,r,l,a,n){if(1===l){let f=0;for(let r=0;r<l;r++)for(let l=0;l<a;l++)f+=-(l+1)*t*e[l][r];for(let t=0;t<r;t++)n[0][t]*=f}else{let f=new Array(l);for(let t=0;t<l;t++)f[t]=new Array(a);for(let e=0;e<a;e++)f[0][e]=-(e+1)*t;for(let e=1;e<l;e++)for(let r=0;r<a;r++)f[e][r]=f[e-1][r]*(e-(r+1)*t)/(e+1);let o=new Array(l);for(let t=0;t<l;t++)o[t]=new Array(l);let h=new Array(a);for(let t=0;t<l;t++){for(let r=0;r<a;r++)h[r]=e[r][t];for(let e=0;e<l;e++){let r=0;for(let t=0;t<a;t++)r+=f[e][t]*h[t];o[e][t]=r}}let i=new Array(l);for(let t=0;t<l;t++)i[t]=[...n[t]];for(let t=0;t<l;t++){n[t].fill(0);for(let e=0;e<l;e++){let l=o[e][t];for(let a=0;a<r;a++)n[t][a]+=i[e][a]*l}}}}function initLU(t,e,r){const l=r.length;for(let a=0;a<l;a++){for(let n=0;n<l;n++)r[a][n]=-e*t[a][n];r[a][a]+=1}}function lu(t){const e=t.length;let r=new Array(e);for(let t=0;t<e;t++)r[t]=t;let l=new Array(e);for(let a=0;a<e;a++){for(let r=0;r<e;r++)l[r]=t[r][a];for(let r=0;r<e;r++){let e=t[r],n=Math.min(r,a),f=0;for(let t=0;t<n;t++)f+=e[t]*l[t];e[a]=l[r]-=f}let n=a;for(let t=a+1;t<e;t++)Math.abs(l[t])>Math.abs(l[n])&&(n=t);if(n!==a){for(let r=0;r<e;r++){let e=t[n][r];t[n][r]=t[a][r],t[a][r]=e}let l=r[n];r[n]=r[a],r[a]=l}if(a<e&&0!==t[a][a])for(let r=a+1;r<e;r++)t[r][a]/=t[a][a]}return r}function lusolve(t,e,r){const l=r.length;let a=e.map((t=>r[t]));for(let e=0;e<l;e++)for(let r=e+1;r<l;r++)a[r]-=a[e]*t[r][e];for(let e=l-1;e>=0;e--){a[e]/=t[e][e];for(let r=0;r<e;r++)a[r]-=a[e]*t[r][e]}return a}function norm(t){return Math.sqrt(t.reduce(((t,e)=>t+e**2),0))}function ntrpndf(t,e,r,l,a,n,f){const o=r.length,h=(t-e)/l;let i=[...r];if(1===n)for(let t=0;t<o;t++)i[t]+=a[0][t]*h;else{let t=1;for(let e=0;e<n;e++){t*=(h+e)/(e+1);for(let r=0;r<o;r++)i[r]+=a[e][r]*t}}for(let t=0;t<f.length;t++){let e=f[t];i[e]=Math.max(0,i[e])}return i}function numjac(t,e,r,l,a,n){const f=r.length;n||(n=new Array(f)).fill(Math.sqrt(EPS));let o=new Array(f),h=new Array(f),i=new Array(f);for(let t=0;t<f;t++)h[t]=new Array(f),i[t]=new Array(f);let M=new Array(f);for(let s=0;s<f;s++){M[s]=Math.max(Math.abs(r[s]),a[s]);let A=r[s]+n[s]*M[s]-r[s];if(0===A)for(;;){if(!(n[s]<FAC_MAX)){A=a[s];break}if(n[s]=Math.min(100*n[s],FAC_MAX),A=r[s]+n[s]*M[s]-r[s],0!==A)break}A=Math.sign(l[s])>=0?Math.abs(A):-Math.abs(A);let b=[...r];b[s]+=A,o[s]=t(e,b);for(let t=0;t<f;t++){let e=o[s][t]-l[t];h[s][t]=e,i[t][s]=e/A}}let s=new Array(f),A=new Array(f);for(let t=0;t<f;t++){s[t]=Math.abs(h[t][0]),A[t]=0;for(let e=1;e<f;e++){let r=Math.abs(h[t][e]);r>s[t]&&(s[t]=r,A[t]=e)}}let b=new Array(f);for(let t=0;t<f;t++)b[t]=Math.abs(o[t][A[t]]);let m=new Array(f),u=new Array(f);for(let t=0;t<f;t++)m[t]=Math.abs(l[t]);for(let t=0;t<f;t++)u[t]=Math.abs(l[A[t]]);let w=new Array(f),y=!1;for(let t=0;t<f;t++)w[t]=0!==b[t]&&0!==u[t]||0===s[t],y=y||w[t];if(y){let a=[...r],o=new Array(f);for(let t=0;t<f;t++)o[t]=Math.max(b[t],u[t]);for(let h=0;h<f;h++)if(w[h]&&s[h]<=BR*o[h]){let o=Math.min(Math.sqrt(n[h]),FAC_MAX),s=r[h]+o*M[h]-r[h];if(o!==n[h]&&0!==s){s=l[h]>=0?Math.abs(s):-Math.abs(s),a[h]=r[h]+s;let M=t(e,a);a[h]=r[h];let A=new Array(f),b=new Array(f);for(let t=0;t<f;t++)A[t]=M[t]-l[t],b[t]=A[t]/s;let u=Math.abs(A[0]),w=0,y=Math.abs(b[0]),g=Math.abs(i[0][h]);for(let t=1;t<f;t++)Math.abs(A[t])>u&&(u=Math.abs(A[t]),w=t),Math.abs(b[t])>y&&(y=Math.abs(b[t])),Math.abs(i[t][h])>g&&(g=Math.abs(i[t][h]));if(o*y>=g){for(let t=0;t<f;t++)i[t][h]=b[t];let t=Math.max(Math.abs(M[w]),m[w]);n[h]=u<=BL*t?Math.min(10*o,FAC_MAX):u>BU*t?Math.max(.1*o,FAC_MIN):o}}}for(let t=0;t<f;t++)w[t]&&s[t]>BR*o[t]&&s[t]<=BL*o[t]&&(n[t]=Math.min(10*n[t],FAC_MAX));for(let t=0;t<f;t++)w[t]&&s[t]>BU*o[t]&&(n[t]=Math.max(.1*n[t],FAC_MIN))}return{dFdy:i,fac:n}}function odeNonNegative(t,e){return function(r,l){dydt=t(r,l);for(let t=0;t<e.length;t++)l[e[t]]<0&&(dydt[e[t]]=Math.max(0,dydt[e[t]]));return dydt}}function nextUp(t){if(t!=t)return t;if(t===-1/0)return-MAX_VALUE;if(t===1/0)return 1/0;if(t===MAX_VALUE)return 1/0;let e=t*(t<0?1-EPS/2:1+EPS);e===t&&(e=MIN_VALUE*EPS>0?t+MIN_VALUE*EPS:t+MIN_VALUE),e===1/0&&(e=+MAX_VALUE);let r=t+(e-t)/2;t<r&&r<e&&(e=r);let l=(e+t)/2;return t<l&&l<e&&(e=l),0===e?-0:e}function nextDown(t){return-nextUp(-t)}function ulp(t){return t<0?nextUp(t)-t:t- -nextUp(-t)}function odezero(t,e,r,l,a,n,f,o,h,i,M){const s=Math.sign(a-r),A=e.length,b=t.isTerminal(a,n),m=t.direction(a,n),u=t.fun(a,n),w=Math.min(128*Math.max(ulp(r),ulp(a)),Math.abs(a-r));let y,g,x=!1,d=r,p=[...l],c=[...e];for(let t=0;t<u.length;t++)e[t]=u[t];let U=a,E=[...n],L=[...u],F=U,N=new Array(A),_=new Array(A),S=new Array(A);for(;;){let e=0;for(;;){let l=0;for(let t=0;t<A;t++)S[t]=Math.sign(c[t])!==Math.sign(L[t])&&m[t]*(L[t]-c[t])>=0,S[t]&&l++;if(0===l){if(0!==e)throw new Error("An event disappeared (internal error)");return{te:y,ye:g,stop:x}}let f=U-d;if(Math.abs(f)<=w)break;let b=d===r;if(b){b=!1;for(let t=0;t<A;t++)if(S[t]&&0===c[t]&&0!==L[t]){b=!0;break}}if(b)F=d+.5*s*w;else{let t=1;for(let e=0;e<A;e++)if(S[e]){let r=0;0===c[e]?s*F>s*U&&N[e]!==L[e]?(r=1-L[e]*(F-U)/((N[e]-L[e])*f),(r<0||r>1)&&(r=.5)):r=.5:0===L[e]?s*F<s*d&&N[e]!==c[e]?(r=c[e]*(d-F)/((N[e]-c[e])*f),(r<0||r>1)&&(r=.5)):r=.5:r=-c[e]/(L[e]-c[e]),r<t&&(t=r)}t*=Math.abs(f),t=Math.max(.5*w,Math.min(t,Math.abs(f)-.5*w)),F=d+s*t}_=ntrpndf(F,a,n,o,h,i,M),N=t.fun(F,_),l=0;for(let t=0;t<A;t++)S[t]=Math.sign(c[t])!==Math.sign(N[t])&&m[t]*(N[t]-c[t])>=0,S[t]&&l++;if(l>0){let t=U;U=F,F=t;let r=[...E];E=[..._],_=[...r];let l=[...L];if(L=[...N],N=[...l],2===e)for(let t=0;t<A;t++){let e=.5*c[t];Math.abs(e)>=MIN_VALUE&&(c[t]=e)}e=2}else{let t=d;d=F,F=t;let r=[...p];p=[..._],_=[...r];let l=[...c];if(c=[...N],N=[...l],1===e)for(let t=0;t<A;t++){let e=.5*L[t];Math.abs(e)>=MIN_VALUE&&(L[t]=e)}e=1}}let l=1/0;for(let t=0;t<A;t++)S[t]&&(l=Math.min(l,U));l<1/0&&(y=l,g=E);for(let e=0;e<A;e++)if(S[e]){if(b[e])return d!==f&&(x=!0),{te:y,ye:g,stop:x};if(Math.abs(a-U)<=w)return{te:y,ye:g,stop:x};F=U,_=[...E],N=[...L],d=U+.5*s*w,p=ntrpndf(d,a,n,o,h,i,M),c=t.fun(d,p),U=a,E=[...n],L=[...u]}}return{te:y,ye:g,stop:x}}